name: .NET CI/CD - Multi-Platform Release

# è§¦å‘æ¡ä»¶ï¼šä¸»åˆ†æ”¯æ¨é€ã€PRã€æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒè‡ªå®šä¹‰Tagåç¼€ï¼‰
on:
  push:
    branches: [ main, master ]
    paths-ignore:  # å¿½ç•¥æ–‡æ¡£/é…ç½®å˜æ›´ï¼Œé¿å…æ— æ•ˆæ„å»º
      - '**.md'
      - '**.gitignore'
      - '.github/**/*.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      tagSuffix:
        description: 'Tagåç¼€ï¼ˆå¯é€‰ï¼Œå¦‚ beta1ã€rc2ï¼‰'
        required: false
        default: ''
        type: string
      preRelease:
        description: 'æ˜¯å¦æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: 'false'
        type: boolean

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  SOLUTION_PATH: ./src/GeneralUpdate.Tool.Avalonia.sln  # è§£å†³æ–¹æ¡ˆè·¯å¾„
  PUBLISH_DIR: ./publish                                # å‘å¸ƒæ ¹ç›®å½•
  PROJECT_NAME: GeneralUpdate.Tool.Avalonia             # é¡¹ç›®åç§°

jobs:
  # å¤šå¹³å°æ„å»ºä½œä¸šï¼ˆWindows/Linux åˆ†åˆ«ç”¨å¯¹åº”ç³»ç»Ÿè¿è¡Œå™¨ï¼Œé¿å…äº¤å‰ç¼–è¯‘é—®é¢˜ï¼‰
  build:
    name: Build ${{ matrix.os }} - ${{ matrix.target-os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å¦ä¸€ä¸ª
      matrix:
        # è¿è¡Œå™¨ + ç›®æ ‡å¹³å° åŒ¹é…
        os: [windows-latest, ubuntu-latest]
        target-os: [win-x64, linux-x64]
        # ç¡®ä¿è¿è¡Œå™¨å’Œç›®æ ‡å¹³å°ä¸€ä¸€å¯¹åº”
        exclude:
          - os: windows-latest
            target-os: linux-x64
          - os: ubuntu-latest
            target-os: win-x64

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆæ‹‰å–å®Œæ•´å†å²ï¼Œç”¨äºTagæ“ä½œï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰å†å²è®°å½•
          lfs: false     # éLFSé¡¹ç›®ç¦ç”¨ï¼ŒåŠ é€Ÿæ£€å‡º

      # 2. è®¾ç½® .NET SDKï¼ˆå¸¦ç¼“å­˜ï¼Œè‡ªåŠ¨å¤„ç†é”æ–‡ä»¶ï¼‰
      - name: Setup .NET SDK 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          cache: true
          cache-dependency-path: |  # æŒ‡å®šç¼“å­˜ä¾èµ–è·¯å¾„ï¼Œé€‚é…é”æ–‡ä»¶
            ${{ env.SOLUTION_PATH }}
            **/packages.lock.json

      # 3. ç”Ÿæˆ/è¿˜åŸä¾èµ–é”æ–‡ä»¶ï¼ˆè§£å†³lockæ–‡ä»¶ç¼ºå¤±é—®é¢˜ï¼‰
      - name: Restore dependencies (generate lock file if missing)
        run: |
          # ç”Ÿæˆé”æ–‡ä»¶ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰+ è¿˜åŸä¾èµ–
          dotnet restore ${{ env.SOLUTION_PATH }} --generate-lock-file --locked-mode
          # éªŒè¯ä¾èµ–è¿˜åŸæˆåŠŸ
          if [ $? -ne 0 ]; then
            echo "âŒ ä¾èµ–è¿˜åŸå¤±è´¥ï¼Œè¯·æ£€æŸ¥é¡¹ç›®ä¾èµ–é…ç½®"
            exit 1
          fi
        shell: bash  # ç»Ÿä¸€ç”¨bashï¼Œè·¨å¹³å°å…¼å®¹

      # 4. æ„å»ºReleaseç‰ˆæœ¬ï¼ˆéå‘å¸ƒï¼Œä»…ç¼–è¯‘éªŒè¯ï¼‰
      - name: Build Release version
        run: |
          dotnet build ${{ env.SOLUTION_PATH }} \
            -c Release \
            -r ${{ matrix.target-os }} \
            --no-restore \
            /p:WarningLevel=1  # é™ä½è­¦å‘Šçº§åˆ«ï¼Œé¿å…éè‡´å‘½è­¦å‘Šä¸­æ–­æ„å»º
        shell: bash

      # 5. å‘å¸ƒåº”ç”¨ï¼ˆç”Ÿæˆæœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
      - name: Publish application
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}
          
          # å‘å¸ƒå‘½ä»¤ï¼ˆé€‚é…Avaloniaè·¨å¹³å°ï¼‰
          dotnet publish ${{ env.SOLUTION_PATH }} \
            -c Release \
            -r ${{ matrix.target-os }} \
            -o ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }} \
            --no-build \
            --self-contained true \
            /p:PublishSingleFile=true \
            /p:PublishTrimmed=true \
            /p:TrimUnusedDependencies=true \
            /p:DebugType=None \
            /p:DebugSymbols=false \
            /p:AssemblyVersion=1.0.${{ github.run_number }} \
            /p:FileVersion=1.0.${{ github.run_number }} \
            /p:UseAppHost=true
          
          # éªŒè¯å‘å¸ƒç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶
          if [ $(ls -A ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }} | wc -l) -eq 0 ]; then
            echo "âŒ å‘å¸ƒç›®å½•ä¸ºç©ºï¼Œå‘å¸ƒå¤±è´¥"
            exit 1
          fi
        shell: bash

      # 6. å¤„ç†Linuxæƒé™ï¼ˆä»…Linuxå¹³å°ï¼‰
      - name: Set execute permission (Linux only)
        if: matrix.target-os == 'linux-x64'
        run: |
          chmod +x ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}/${{ env.PROJECT_NAME }}
          # éªŒè¯æƒé™è®¾ç½®
          if [ ! -x ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}/${{ env.PROJECT_NAME }} ]; then
            echo "âŒ Linuxå¯æ‰§è¡Œæ–‡ä»¶æƒé™è®¾ç½®å¤±è´¥"
            exit 1
          fi
        shell: bash

      # 7. æ‰“åŒ…å‘å¸ƒæ–‡ä»¶ï¼ˆæŒ‰å¹³å°+æ—¥æœŸå‘½åï¼‰
      - name: Package release files
        id: package
        run: |
          # ç”Ÿæˆæ—¥æœŸï¼ˆç»Ÿä¸€æ ¼å¼ï¼šYYYYMMDDï¼‰
          DATE=$(date +%Y%m%d)
          # å‹ç¼©åŒ…åç§°ï¼šé¡¹ç›®å_å¹³å°_æ—¥æœŸ.zip
          ZIP_NAME="${{ env.PROJECT_NAME }}_${{ matrix.target-os }}_${DATE}.zip"
          ZIP_PATH="${{ env.PUBLISH_DIR }}/${ZIP_NAME}"

          # æ‰“åŒ…ï¼ˆWindowsç”¨PowerShellï¼ŒLinuxç”¨zipï¼‰
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            powershell Compress-Archive -Path "${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}/*" -DestinationPath "$ZIP_PATH" -Force
          else
            zip -r "$ZIP_PATH" "${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}/*"
          fi

          # éªŒè¯å‹ç¼©åŒ…
          if [ ! -f "$ZIP_PATH" ]; then
            echo "âŒ å‹ç¼©åŒ…ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

          # è¾“å‡ºå‹ç¼©åŒ…ä¿¡æ¯ï¼ˆä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "zip_path=$ZIP_PATH" >> $GITHUB_OUTPUT
          echo "âœ… å‹ç¼©åŒ…ç”ŸæˆæˆåŠŸï¼š$ZIP_NAME"
        shell: bash

      # 8. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä¿ç•™åˆ°Releaseæ­¥éª¤ï¼‰
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target-os }}_artifact
          path: ${{ steps.package.outputs.zip_path }}
          retention-days: 7  # äº§ç‰©ä¿ç•™7å¤©ï¼Œé¿å…å­˜å‚¨å ç”¨
          if-no-files-found: error  # æ— æ–‡ä»¶åˆ™æŠ¥é”™

  # å‘å¸ƒReleaseä½œä¸šï¼ˆä¾èµ–buildå®Œæˆï¼Œä»…Push/æ‰‹åŠ¨è§¦å‘ï¼‰
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build  # ç­‰å¾…æ‰€æœ‰æ„å»ºå®Œæˆ
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write  # æ˜¾å¼æˆäºˆå†™æƒé™ï¼Œé¿å…Tag/Pushå¤±è´¥

    steps:
      # 1. ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: false  # ä¿ç•™å¹³å°ç›®å½•ç»“æ„

      # 2. é…ç½®Gitç”¨æˆ·ï¼ˆç”¨äºæ¨é€Tagï¼‰
      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git fetch --tags  # æ‹‰å–å·²æœ‰Tagï¼Œé¿å…é‡å¤
        shell: bash

      # 3. ç”Ÿæˆæ—¥æœŸTagï¼ˆé¿å…é‡å¤ï¼‰
      - name: Generate date-based Tag
        id: create_tag
        run: |
          # åŸºç¡€Tagï¼švYYYYMMDD
          BASE_TAG="v$(date +%Y%m%d)"
          # æ‹¼æ¥åç¼€ï¼ˆå¦‚ v20240103-beta1ï¼‰
          TAG_SUFFIX="${{ github.event.inputs.tagSuffix }}"
          if [ -n "$TAG_SUFFIX" ]; then
            FINAL_TAG="${BASE_TAG}-${TAG_SUFFIX}"
          else
            FINAL_TAG="${BASE_TAG}"
          fi

          # æ£€æŸ¥Tagæ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$FINAL_TAG" >/dev/null 2>&1; then
            echo "â„¹ï¸ Tag $FINAL_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            # åˆ›å»ºå¹¶æ¨é€Tag
            git tag "$FINAL_TAG"
            git push origin "$FINAL_TAG"
            echo "âœ… æˆåŠŸåˆ›å»ºTagï¼š$FINAL_TAG"
          fi

          # è¾“å‡ºTagåç§°ï¼ˆä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          echo "tag_name=$FINAL_TAG" >> $GITHUB_OUTPUT
        shell: bash

      # 4. åˆ›å»ºGitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          name: Release ${{ steps.create_tag.outputs.tag_name }}
          body: |
            ## ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ
            - æ„å»ºæ—¥æœŸï¼š${{ steps.create_tag.outputs.tag_name }}
            - æ„å»ºç¼–å·ï¼š${{ github.run_number }}
            - åŒ…å«å¹³å°ï¼šWindows x64 / Linux x64
            - æ„å»ºæ¨¡å¼ï¼šRelease | å•æ–‡ä»¶ | è‡ªåŒ…å« | ä¾èµ–è£å‰ª
          # ä¸Šä¼ æ‰€æœ‰å¹³å°çš„å‹ç¼©åŒ…
          files: |
            ./artifacts/win-x64_artifact/*.zip
            ./artifacts/linux-x64_artifact/*.zip
          # é¢„å‘å¸ƒæ ‡è®°ï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶å¯è‡ªå®šä¹‰ï¼Œæœ‰åç¼€é»˜è®¤é¢„å‘å¸ƒï¼‰
          prerelease: ${{ github.event.inputs.preRelease == 'true' || github.event.inputs.tagSuffix != '' }}
          draft: false  # ç›´æ¥å‘å¸ƒï¼Œä¸åˆ›å»ºè‰ç¨¿
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHubè‡ªåŠ¨æ³¨å…¥çš„ä»¤ç‰Œ

      # 5. æ¸…ç†äº§ç‰©ï¼ˆå¯é€‰ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ï¼‰
      - name: Cleanup artifacts
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥éƒ½æ‰§è¡Œ
        run: |
          rm -rf ./artifacts
          echo "âœ… äº§ç‰©æ¸…ç†å®Œæˆ"
        shell: bash
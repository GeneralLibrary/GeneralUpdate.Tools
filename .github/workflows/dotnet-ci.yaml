name: .NET CI/CD - Multi-Platform Release

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '**.gitignore'
      - '.github/**/*.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      tagSuffix:
        description: 'Tagåç¼€ï¼ˆå¯é€‰ï¼Œå¦‚ beta1ã€rc2ï¼‰'
        required: false
        default: ''
        type: string
      preRelease:
        description: 'æ˜¯å¦æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: 'false'
        type: boolean

env:
  SOLUTION_PATH: ./src/GeneralUpdate.Tool.Avalonia.sln
  PUBLISH_DIR: ./publish
  PROJECT_NAME: GeneralUpdate.Tool.Avalonia
  DOTNET_SDK_VERSION: '8.0.x'  # æ˜¾å¼æŒ‡å®šSDKç‰ˆæœ¬ï¼Œé¿å…è‡ªåŠ¨å‡çº§åˆ°é¢„è§ˆç‰ˆ

jobs:
  build:
    name: Build ${{ matrix.os }} - ${{ matrix.target-os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]
        target-os: [win-x64, linux-x64]
        exclude:
          - os: windows-latest
            target-os: linux-x64
          - os: ubuntu-latest
            target-os: win-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: false

      # å¼ºåˆ¶æŒ‡å®šSDKç‰ˆæœ¬ï¼Œé¿å…ä½¿ç”¨é¢„è§ˆç‰ˆï¼ˆå¦‚10.0ï¼‰
      - name: Setup .NET SDK ${{ env.DOTNET_SDK_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_SDK_VERSION }}
          cache: true
          cache-dependency-path: |
            ${{ env.SOLUTION_PATH }}
            **/packages.lock.json

      # ä¿®å¤æ ¸å¿ƒï¼šæ‹†åˆ†é”æ–‡ä»¶ç”Ÿæˆå’Œä¾èµ–è¿˜åŸï¼ˆé¿å…å‚æ•°å†²çªï¼‰
      - name: Generate packages.lock.json (if missing)
        run: |
          # ä»…å½“é”æ–‡ä»¶ä¸å­˜åœ¨æ—¶ç”Ÿæˆï¼ˆé¿å…è¦†ç›–å·²æœ‰é”æ–‡ä»¶ï¼‰
          if [ ! -f "./src/packages.lock.json" ]; then
            echo "ğŸ” æœªæ‰¾åˆ°é”æ–‡ä»¶ï¼Œå¼€å§‹ç”Ÿæˆ..."
            dotnet restore ${{ env.SOLUTION_PATH }} --generate-lock-file
            if [ $? -ne 0 ]; then
              echo "âŒ é”æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
              exit 1
            fi
            echo "âœ… é”æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          else
            echo "â„¹ï¸ é”æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡ç”Ÿæˆ"
          fi
        shell: bash

      - name: Restore dependencies (locked mode)
        run: |
          # ä½¿ç”¨å·²å­˜åœ¨çš„é”æ–‡ä»¶è¿˜åŸä¾èµ–ï¼ˆé”å®šæ¨¡å¼ï¼‰
          dotnet restore ${{ env.SOLUTION_PATH }} --locked-mode
          if [ $? -ne 0 ]; then
            echo "âŒ ä¾èµ–è¿˜åŸå¤±è´¥ï¼Œè¯·æ£€æŸ¥é”æ–‡ä»¶æˆ–ä¾èµ–é…ç½®"
            exit 1
          fi
          echo "âœ… ä¾èµ–è¿˜åŸæˆåŠŸ"
        shell: bash

      - name: Build Release version
        run: |
          dotnet build ${{ env.SOLUTION_PATH }} \
            -c Release \
            -r ${{ matrix.target-os }} \
            --no-restore \
            /p:WarningLevel=1
        shell: bash

      - name: Publish application
        run: |
          mkdir -p ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}
          
          dotnet publish ${{ env.SOLUTION_PATH }} \
            -c Release \
            -r ${{ matrix.target-os }} \
            -o ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }} \
            --no-build \
            --self-contained true \
            /p:PublishSingleFile=true \
            /p:PublishTrimmed=true \
            /p:TrimUnusedDependencies=true \
            /p:DebugType=None \
            /p:DebugSymbols=false \
            /p:AssemblyVersion=1.0.${{ github.run_number }} \
            /p:FileVersion=1.0.${{ github.run_number }} \
            /p:UseAppHost=true
          
          if [ $(ls -A ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }} | wc -l) -eq 0 ]; then
            echo "âŒ å‘å¸ƒç›®å½•ä¸ºç©ºï¼Œå‘å¸ƒå¤±è´¥"
            exit 1
          fi
        shell: bash

      - name: Set execute permission (Linux only)
        if: matrix.target-os == 'linux-x64'
        run: |
          chmod +x ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}/${{ env.PROJECT_NAME }}
          if [ ! -x ${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}/${{ env.PROJECT_NAME }} ]; then
            echo "âŒ Linuxå¯æ‰§è¡Œæ–‡ä»¶æƒé™è®¾ç½®å¤±è´¥"
            exit 1
          fi
        shell: bash

      - name: Package release files
        id: package
        run: |
          DATE=$(date +%Y%m%d)
          ZIP_NAME="${{ env.PROJECT_NAME }}_${{ matrix.target-os }}_${DATE}.zip"
          ZIP_PATH="${{ env.PUBLISH_DIR }}/${ZIP_NAME}"

          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            powershell Compress-Archive -Path "${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}/*" -DestinationPath "$ZIP_PATH" -Force
          else
            zip -r "$ZIP_PATH" "${{ env.PUBLISH_DIR }}/${{ matrix.target-os }}/*"
          fi

          if [ ! -f "$ZIP_PATH" ]; then
            echo "âŒ å‹ç¼©åŒ…ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "zip_path=$ZIP_PATH" >> $GITHUB_OUTPUT
          echo "âœ… å‹ç¼©åŒ…ç”ŸæˆæˆåŠŸï¼š$ZIP_NAME"
        shell: bash

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target-os }}_artifact
          path: ${{ steps.package.outputs.zip_path }}
          retention-days: 7
          if-no-files-found: error

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: false

      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git fetch --tags
        shell: bash

      - name: Generate date-based Tag
        id: create_tag
        run: |
          BASE_TAG="v$(date +%Y%m%d)"
          TAG_SUFFIX="${{ github.event.inputs.tagSuffix }}"
          if [ -n "$TAG_SUFFIX" ]; then
            FINAL_TAG="${BASE_TAG}-${TAG_SUFFIX}"
          else
            FINAL_TAG="${BASE_TAG}"
          fi

          if git rev-parse "$FINAL_TAG" >/dev/null 2>&1; then
            echo "â„¹ï¸ Tag $FINAL_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            git tag "$FINAL_TAG"
            git push origin "$FINAL_TAG"
            echo "âœ… æˆåŠŸåˆ›å»ºTagï¼š$FINAL_TAG"
          fi

          echo "tag_name=$FINAL_TAG" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          name: Release ${{ steps.create_tag.outputs.tag_name }}
          body: |
            ## ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ
            - æ„å»ºæ—¥æœŸï¼š${{ steps.create_tag.outputs.tag_name }}
            - æ„å»ºç¼–å·ï¼š${{ github.run_number }}
            - åŒ…å«å¹³å°ï¼šWindows x64 / Linux x64
            - æ„å»ºæ¨¡å¼ï¼šRelease | å•æ–‡ä»¶ | è‡ªåŒ…å« | ä¾èµ–è£å‰ª
          files: |
            ./artifacts/win-x64_artifact/*.zip
            ./artifacts/linux-x64_artifact/*.zip
          prerelease: ${{ github.event.inputs.preRelease == 'true' || github.event.inputs.tagSuffix != '' }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup artifacts
        if: always()
        run: |
          rm -rf ./artifacts
          echo "âœ… äº§ç‰©æ¸…ç†å®Œæˆ"
        shell: bash